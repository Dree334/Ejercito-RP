<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>S.U.K.V. - Sistema de Sanciones (Funcional)</title>
</head>
<body>

    <h2>REGISTRO DE SANCIÓN MILITAR</h2>
    
    <div style="border: 1px solid #000; padding: 15px; margin-bottom: 20px;">
        <input type="text" id="nombre_ic" placeholder="Nombre IC del Soldado"><br><br>
        <input type="text" id="placa" placeholder="Placa (CW-00)"><br><br>
        <input type="text" id="discord" placeholder="ID de Discord (Numérico)"><br><br>
        
        <label>Nivel de Strike:</label>
        <select id="nivel">
            <option value="1">Strike 1</option>
            <option value="2">Strike 2</option>
            <option value="3">Strike 3</option>
        </select><br><br>
        
        <textarea id="motivo" placeholder="Motivo del reporte" rows="4"></textarea><br><br>
        
        <button onclick="enviarSancion()">EJECUTAR PROTOCOLO</button>
    </div>

    <hr>

    <h2>REGISTROS EN BASE DE DATOS</h2>
    <table border="1" style="width:100%; text-align:left;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Soldado</th>
                <th>Placa</th>
                <th>Strike</th>
                <th>Fecha</th>
                <th>Motivo</th>
            </tr>
        </thead>
        <tbody id="tabla-cuerpo">
            </tbody>
    </table>

    <script>
        // 1. CARGAR DATOS AL INICIAR
        async function cargarTabla() {
            try {
                const res = await fetch('/api/sancionar');
                if (!res.ok) throw new Error("No se pudo conectar con la API");
                
                const data = await res.json();
                const tabla = document.getElementById('tabla-cuerpo');
                tabla.innerHTML = "";

                data.forEach(s => {
                    tabla.innerHTML += `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.nombre_ic}</td>
                            <td>${s.placa}</td>
                            <td>STRIKE ${s.nivel}</td>
                            <td>${s.fecha}</td>
                            <td>${s.motivo}</td>
                        </tr>`;
                });
            } catch (err) {
                console.error("Error al cargar:", err);
                alert("Error de sincronización: " + err.message);
            }
        }

        // 2. ENVIAR NUEVA SANCIÓN
        async function enviarSancion() {
            const payload = {
                nombre_ic: document.getElementById('nombre_ic').value,
                placa: document.getElementById('placa').value,
                discord: document.getElementById('discord').value,
                nivel: parseInt(document.getElementById('nivel').value),
                motivo: document.getElementById('motivo').value,
                fecha: new Date().toLocaleDateString('es-CO')
            };

            if (!payload.nombre_ic || !payload.motivo) {
                alert("Faltan campos obligatorios");
                return;
            }

            try {
                const res = await fetch('/api/sancionar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Sanción registrada correctamente.");
                    // Limpiar campos
                    document.getElementById('nombre_ic').value = "";
                    document.getElementById('motivo').value = "";
                    // Recargar tabla
                    cargarTabla();
                } else {
                    const errorMsg = await res.text();
                    alert("Error en el servidor: " + errorMsg);
                }
            } catch (err) {
                alert("Error de red: " + err.message);
            }
        }

        // Ejecutar carga inicial
        document.addEventListener('DOMContentLoaded', cargarTabla);
    </script>

</body>
</html>
